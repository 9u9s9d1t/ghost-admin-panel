<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Ghost Admin Pro</title>
    <style>
        :root { --bg: #0d1117; --panel: #161b22; --border: #30363d; --text: #c9d1d9; --accent: #238636; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 1300px; margin: 0 auto; }
        
        /* Header & Panel */
        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .panel { background: var(--panel); padding: 20px; border-radius: 8px; border: 1px solid var(--border); display: flex; gap: 12px; margin-bottom: 20px; }
        
        /* Table Style */
        .table-container { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th { background: #000; color: #8b949e; font-size: 12px; text-transform: uppercase; padding: 15px; }
        td { padding: 12px 15px; border-top: 1px solid var(--border); vertical-align: middle; }
        tr:hover { background: rgba(255,255,255,0.02); }

        /* Buttons */
        .btn { padding: 6px 12px; border: 1px solid rgba(240,246,255,0.1); border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: 0.2s; color: white; }
        .btn:active { transform: translateY(1px); }
        .btn-blue { background: #1f6feb; }
        .btn-green { background: #238636; }
        .btn-red { background: #da3633; }
        .btn-orange { background: #d29922; }
        .btn-purple { background: #8957e5; }
        .btn-cyan { background: #0891b2; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: #8b949e; }
        .btn-outline:hover { border-color: #8b949e; color: #fff; }

        /* Status Colors */
        .status-badge { padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; }
        .status-on { background: rgba(46, 160, 67, 0.15); color: #3fb950; border: 1px solid rgba(46,160,67,0.4); }
        .status-off { background: rgba(248, 81, 73, 0.15); color: #f85149; border: 1px solid rgba(248,81,73,0.4); }

        /* Modals */
        .modal { display: none; position: fixed; z-index: 1000; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); }
        .modal-content { background: var(--panel); margin: 5% auto; padding: 25px; width: 50%; border-radius: 12px; border: 1px solid var(--border); position: relative; }
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 13px; color: #8b949e; }
        input, select, textarea { width: 100%; padding: 8px; background: #0d1117; border: 1px solid var(--border); color: #fff; border-radius: 6px; box-sizing: border-box; }
        textarea { height: 250px; font-family: monospace; }
        
        .actions-cell { display: flex; gap: 5px; flex-wrap: wrap; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-flex">
            <h1>GhostType Dashboard <span id="onlineCounter" style="font-size: 16px; color: #8b949e; margin-left:15px;"></span></h1>
            <div>
                <a href="/api/download_report" class="btn btn-green">üìä –°–ö–ê–ß–ê–¢–¨ –û–¢–ß–ï–¢</a>
            </div>
        </div>

        <div class="panel">
            <input type="text" id="globalText" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π —É–≤–∏–¥—è—Ç –≤—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏...">
            <button class="btn btn-blue" style="white-space:nowrap" onclick="adminAction('set_text', 'all', {text: document.getElementById('globalText').value})">–û–¢–ü–†–ê–í–ò–¢–¨ –í–°–ï–ú</button>
            <button class="btn btn-outline" onclick="adminAction('reset', 'all')">–°–ë–†–û–°–ò–¢–¨ –í–°–ï–•</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>–°–û–¢–†–£–î–ù–ò–ö</th>
                        <th>–†–ï–ñ–ò–ú</th>
                        <th>–°–û–û–ë–©–ï–ù–ò–ô</th>
                        <th>CPM</th>
                        <th>–°–¢–ê–¢–£–°</th>
                        <th>–ü–û–°–õ–ï–î–ù–ò–ô –í–•–û–î</th>
                        <th>–£–ü–†–ê–í–õ–ï–ù–ò–ï</th>
                    </tr>
                </thead>
                <tbody id="workerTable"></tbody>
            </table>
        </div>
    </div>

    <div id="editorModal" class="modal"><div class="modal-content"><h3>–†–µ–¥–∞–∫—Ç–æ—Ä —Ñ—Ä–∞–∑</h3><textarea id="editArea"></textarea><div style="margin-top:15px"><button class="btn btn-green" onclick="savePhrases()">–°–û–•–†–ê–ù–ò–¢–¨</button> <button class="btn btn-outline" onclick="closeModals()">–û–¢–ú–ï–ù–ê</button></div></div></div>
    
    <div id="shotModal" class="modal"><div class="modal-content" style="width: 80%;"><h3>–°–∫—Ä–∏–Ω—à–æ—Ç</h3><div id="shotLoading"></div><img id="shotImg" style="width:100%; border-radius:8px; display:none;"><br><br><button class="btn btn-outline" onclick="closeModals()">–ó–ê–ö–†–´–¢–¨</button></div></div>

    <div id="configModal" class="modal"><div class="modal-content" style="width: 350px;"><h3>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</h3>
        <div class="input-group"><label>–ú–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏</label><select id="confMode"><option value="Type">Type (–ü–µ—á–∞—Ç—å)</option><option value="Paste">Paste (–í—Å—Ç–∞–≤–∫–∞)</option></select></div>
        <div class="input-group"><label>–ó–∞–¥–µ—Ä–∂–∫–∞ (—Å–µ–∫)</label><input type="number" step="0.1" id="confSpeed"></div>
        <div class="input-group"><label>–°—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π</label><input type="number" id="confTotal"></div>
        <button class="btn btn-green" onclick="saveConfigRemote()">–û–ë–ù–û–í–ò–¢–¨</button> <button class="btn btn-outline" onclick="closeModals()">–û–¢–ú–ï–ù–ê</button>
    </div></div>

    <script>
        let currentWorker = "";

        async function refreshData() {
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É, —á—Ç–æ–±—ã —Ñ–æ–∫—É—Å –Ω–µ —Å–ª–µ—Ç–∞–ª
            if (document.querySelector('.modal[style*="display: block"]')) return;
            
            try {
                const res = await fetch('/api/get_workers');
                const workers = await res.json();
                let html = "";
                const sortedEntries = Object.entries(workers).sort((a, b) => b[1].total - a[1].total);
                
                sortedEntries.forEach(([name, w]) => {
                    const statusClass = w.status === '–†–ê–ë–û–¢–ê–ï–¢' ? 'status-on' : 'status-off';
                    html += `<tr>
                        <td><strong>${name}</strong></td>
                        <td><code style="color:#8b949e">${w.mode}</code></td>
                        <td><span style="color:#3fb950; font-weight:bold">${w.total}</span></td>
                        <td>${w.cpm}</td>
                        <td><span class="status-badge ${statusClass}">${w.status}</span></td>
                        <td><small style="color:#555">${w.last_seen || '...'}</small></td>
                        <td>
                            <div class="actions-cell">
                                <button class="btn btn-cyan" onclick="takeShot('${name}')" title="–°–∫—Ä–∏–Ω—à–æ—Ç">üì∏</button>
                                <button class="btn btn-blue" onclick="openEditor('${name}', \`${w.phrases}\`)" title="–¢–µ–∫—Å—Ç">TXT</button>
                                <button class="btn btn-purple" onclick="openConfig('${name}', '${w.mode}', ${w.speed}, ${w.total})" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
                                <button class="btn btn-orange" onclick="adminAction('toggle_status', '${name}')" title="–ü–∞—É–∑–∞/–ü—É—Å–∫">‚èØ</button>
                                <button class="btn btn-outline" onclick="adminAction('reset', '${name}')" title="–°–±—Ä–æ—Å">üîÑ</button>
                                <button class="btn btn-red" onclick="deleteWorker('${name}')" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>
                            </div>
                        </td>
                    </tr>`;
                });
                document.getElementById("workerTable").innerHTML = html;
                document.getElementById("onlineCounter").innerText = `–í—Å–µ–≥–æ: ${Object.keys(workers).length}`;
            } catch (e) { console.error("Sync error"); }
        }

        async function deleteWorker(name) {
            if (confirm(`–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ${name}? –û–Ω –∏—Å—á–µ–∑–Ω–µ—Ç –∏–∑ —Å–ø–∏—Å–∫–∞, –ø–æ–∫–∞ —Å–Ω–æ–≤–∞ –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É.`)) {
                await adminAction('delete', name);
            }
        }

        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ª–æ–≥–∏–∫–∏) ---
        async function takeShot(name) {
            currentWorker = name;
            await adminAction('shot', name);
            document.getElementById('shotModal').style.display = 'block';
            document.getElementById('shotImg').style.display = 'none';
            document.getElementById('shotLoading').innerText = "–ó–∞–ø—Ä–∞—à–∏–≤–∞—é —Å–∫—Ä–∏–Ω—à–æ—Ç... –û–∂–∏–¥–∞–π—Ç–µ.";
            let attempts = 0;
            const checkShot = setInterval(async () => {
                const res = await fetch(`/api/get_screenshot/${name}`);
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('shotImg').src = "data:image/jpeg;base64," + data.image;
                    document.getElementById('shotImg').style.display = 'block';
                    document.getElementById('shotLoading').innerText = "";
                    clearInterval(checkShot);
                }
                if (++attempts > 10) {
                    document.getElementById('shotLoading').innerText = "–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª (–æ—Ñ—Ñ–ª–∞–π–Ω?)";
                    clearInterval(checkShot);
                }
            }, 2000);
        }

        function openEditor(n, p) { currentWorker = n; document.getElementById('editArea').value = p; document.getElementById('editorModal').style.display = 'block'; }
        function openConfig(n, m, s, t) { currentWorker = n; document.getElementById('confMode').value = m; document.getElementById('confSpeed').value = s; document.getElementById('confTotal').value = t; document.getElementById('configModal').style.display = 'block'; }
        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
        async function savePhrases() { await adminAction('set_text', currentWorker, {text: document.getElementById('editArea').value}); closeModals(); }
        async function saveConfigRemote() { 
            await adminAction('update_config', currentWorker, {
                mode: document.getElementById('confMode').value,
                speed: document.getElementById('confSpeed').value,
                total: document.getElementById('confTotal').value
            }); 
            closeModals(); 
        }
        async function adminAction(action, target, data = {}) {
            await fetch('/api/admin_action', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action, target, ...data})
            });
            refreshData();
        }
        setInterval(refreshData, 3000); 
        refreshData();
    </script>
</body>
</html>
